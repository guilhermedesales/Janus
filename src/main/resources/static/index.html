<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Janus - Tarefas</title>
    <style>
        /* reset r√°pido */
        *{box-sizing:border-box;font-family:Inter,Segoe UI,Roboto,Arial;margin:0;padding:0}
        body{display:flex;min-height:100vh;color:#222;background:#f6f7fb}
        /* sidebar */
        .sidebar{width:80px;background:#fff;border-right:1px solid #e6e6e6;display:flex;flex-direction:column;align-items:center;padding:12px 6px;gap:10px}
        .logo{width:56px;height:56px;border-radius:28px;background:#cfcfcf;margin-bottom:8px}
        .menu-item{width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px solid transparent}
        .menu-item.selected{background:#e9f0ff;border-color:#2b67ff;color:#2b67ff}
        .menu-item img{width:26px;height:26px;opacity:.8}
        /* main layout */
        .left-panel{width:300px;background:#fff;border-right:1px solid #eaeaea;padding:18px;display:flex;flex-direction:column;gap:14px}
        .topbar{flex:1;display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:#fff;border-bottom:1px solid #eaeaea;position:fixed;left:80px;right:0;top:0;height:64px;z-index:20}
        .brand{display:flex;align-items:center;gap:12px}
        .brand h1{font-size:20px;color:#2b2b2b}
        .page-title{font-size:22px;color:#1976d2}
        .content{margin-left:80px;margin-top:64px;display:flex;flex:1;width:100%}
        .main{flex:1;padding:24px;display:flex;gap:18px}
        /* filtros */
        .btn{display:inline-block;padding:10px 14px;border-radius:10px;border:2px solid #2b67ff;background:transparent;color:#2b67ff;cursor:pointer}
        .btn-primary{background:#2b67ff;color:#fff;border-color:#2b67ff}
        .filter-group{display:flex;flex-direction:column;gap:8px}
        label{font-weight:600;font-size:14px;color:#333}
        select,input[type=date],textarea{padding:10px;border-radius:10px;border:2px solid #e6e6e6;background:transparent}
        .search-actions{display:flex;gap:8px;align-items:center}
        /* tarefas grid */
        .tasks-area{flex:1;background:transparent;padding:6px;display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;align-content:flex-start}
        .card{background:#fff;border-radius:12px;padding:14px;border:2px solid #efefef;position:relative;min-height:120px;display:flex;flex-direction:column;gap:6px;box-shadow:0 2px 6px rgba(10,10,10,0.03)}
        .card .title{font-weight:800}
        .tag{font-size:12px;padding:6px 8px;border-radius:999px;border:1px solid #eee;display:inline-block}
        .card .meta{font-size:13px;color:#666;display:flex;gap:8px;align-items:center}
        .card .actions{position:absolute;right:10px;top:10px;display:flex;gap:8px}
        .icon-btn{border:none;background:transparent;cursor:pointer;font-weight:700}
        .status-badge{font-size:12px;padding:6px;border-radius:8px}
        .priority-high{color:#d32f2f}
        .priority-med{color:#f57c00}
        .priority-low{color:#388e3c}
        /* modal */
        .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:40}
        .modal{background:#fff;border-radius:12px;padding:18px;width:420px;max-width:92%}
        .modal h3{margin-bottom:10px}
        .modal .row{display:flex;gap:8px}
        .modal .row .col{flex:1}
        .modal form{display:flex;flex-direction:column;gap:10px}
        /* responsive */
        @media (max-width:900px){
          .left-panel{display:none}
          .sidebar{width:60px}
          .topbar{left:60px}
          .content{margin-left:60px}
        }
    </style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="logo" title="Janus"></div>

    <div class="menu-item selected" data-page="tarefas" title="Tarefas">
        üóÇ
    </div>
    <div class="menu-item" data-page="pomodoro" title="Pomodoro">‚è±</div>
    <div class="menu-item" data-page="calendario" title="Calend√°rio">üìÖ</div>
    <div class="menu-item" data-page="estatisticas" title="Estat√≠sticas">üìà</div>
    <div style="flex:1"></div>
    <div class="menu-item" data-page="perfil" title="Perfil">üë§</div>
</div>

<!-- topbar -->
<div class="topbar">
    <div class="brand"><div style="width:36px;height:36px;border-radius:18px;background:#cfcfcf"></div><h1>Janus</h1></div>
    <div class="page-title" id="top-page-title">Se√ß√£o de Foco</div>
    <div style="width:36px;height:36px;border-radius:18px;background:#fff;border:2px solid #1976d2;display:flex;align-items:center;justify-content:center;color:#1976d2;font-weight:700">U</div>
</div>

<div class="content">
    <!-- left filters -->
    <aside class="left-panel" id="left-panel">
        <div style="display:flex;flex-direction:column;gap:8px">
            <button class="btn" id="btn-criar-categoria">Criar Categoria</button>
            <button class="btn" id="btn-criar-tarefa">Criar Tarefa</button>
        </div>

        <div style="margin-top:12px">
            <h3 style="margin-bottom:8px">Buscar Tarefa</h3>

            <div class="filter-group">
                <label>Categoria</label>
                <select id="filter-categoria">
                    <option value="">Todas</option>
                </select>

                <label>Data</label>
                <select id="filter-data">
                    <option value="">Qualquer</option>
                    <option value="hoje">Tarefa do dia</option>
                    <option value="semana">Tarefa da semana</option>
                    <option value="mes">Tarefa do m√™s</option>
                </select>

                <label>Prioridade</label>
                <select id="filter-prioridade">
                    <option value="">Todas</option>
                    <option value="BAIXA">Prioridade Baixa</option>
                    <option value="MEDIA">Prioridade M√©dia</option>
                    <option value="ALTA">Prioridade Alta</option>
                </select>

                <label>Status</label>
                <select id="filter-status">
                    <option value="">Todos</option>
                    <option value="EM_ANDAMENTO">Em andamento</option>
                    <option value="CONCLUIDO">Conclu√≠do</option>
                    <option value="ATRASADO">Atrasado</option>
                </select>

                <div class="search-actions" style="margin-top:8px">
                    <button class="btn" id="btn-buscar">BUSCAR</button>
                    <button class="btn" id="btn-mostrar-todos">MOSTRAR TODOS</button>
                </div>
            </div>
        </div>
    </aside>

    <!-- main content -->
    <main class="main" id="main-area">
        <section style="flex:1">
            <h2 style="margin-bottom:12px">Tarefas</h2>
            <div class="tasks-area" id="tasks-area">
                <!-- cards v√£o aqui -->
            </div>
        </section>
    </main>
</div>

<!-- MODAL criar categoria -->
<div class="modal-backdrop" id="modal-categoria-backdrop">
    <div class="modal">
        <h3>Criar Categoria</h3>
        <form id="form-categoria">
            <input type="text" id="cat-nome" placeholder="Nome" required />
            <textarea id="cat-descricao" placeholder="Descri√ß√£o (opcional)" rows="3"></textarea>
            <div style="display:flex;gap:8px;justify-content:flex-end">
                <button type="button" class="btn" id="cat-cancel">Cancelar</button>
                <button type="submit" class="btn btn-primary">Salvar Categoria</button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL criar tarefa -->
<div class="modal-backdrop" id="modal-tarefa-backdrop">
    <div class="modal">
        <h3>Criar Tarefa</h3>
        <form id="form-tarefa">
            <input type="text" id="task-titulo" placeholder="T√≠tulo" required />
            <textarea id="task-descricao" placeholder="Descri√ß√£o" rows="3"></textarea>

            <div class="row">
                <div class="col">
                    <label>Data de In√≠cio</label>
                    <input type="date" id="task-data-inicio" />
                </div>
                <div class="col">
                    <label>Data de Fim</label>
                    <input type="date" id="task-data-fim" />
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label>Status</label>
                    <select id="task-status">
                        <option value="EM_ANDAMENTO">Em andamento</option>
                        <option value="CONCLUIDO">Conclu√≠do</option>
                        <option value="ATRASADO">Atrasado</option>
                    </select>
                </div>
                <div class="col">
                    <label>Prioridade</label>
                    <select id="task-prioridade">
                        <option value="BAIXA">Baixa</option>
                        <option value="MEDIA">M√©dia</option>
                        <option value="ALTA">Alta</option>
                    </select>
                </div>
            </div>

            <label>Categoria</label>
            <select id="task-categoria">
                <option value="">-- Sem categoria --</option>
            </select>

            <div style="display:flex;gap:8px;justify-content:flex-end">
                <button type="button" class="btn" id="task-cancel">Cancelar</button>
                <button type="submit" class="btn btn-primary">Salvar Tarefa</button>
            </div>
        </form>
    </div>
</div>

<script>
    /***********************
     * CONFIG - ajuste se precisar
     ***********************/
    const API_BASE = ""; // se sua API estiver em outro host, coloque aqui (ex: "http://localhost:8080")
    const ENDPOINTS = {
      categorias_listar: API_BASE + "/categorias/listar",
      categorias_salvar: API_BASE + "/categorias/salvar",
      tarefas_listar: API_BASE + "/tarefas/listar",
      tarefas_salvar: API_BASE + "/tarefas/salvar",
      tarefas_atualizar: API_BASE + "/tarefas/atualizar", // PUT
      tarefas_deletar: API_BASE + "/tarefas/deletar" // DELETE (id no body ou query - veja nota)
    };

    /***********************
     * UI helpers
     ***********************/
    const sidebar = document.getElementById('sidebar');
    const menuItems = sidebar.querySelectorAll('.menu-item');
    const topTitle = document.getElementById('top-page-title');
    const mainArea = document.getElementById('main-area');

    menuItems.forEach(it => {
      it.addEventListener('click', () => {
        menuItems.forEach(m => m.classList.remove('selected'));
        it.classList.add('selected');
        const page = it.dataset.page;
        topTitle.textContent = page.charAt(0).toUpperCase() + page.slice(1);
        // se n√£o for "tarefas", mostramos tela em branco com o t√≠tulo
        if (page !== 'tarefas') {
          showBlankPage(page);
        } else {
          // voltar a tela normal de tarefas
          location.hash = '#tarefas';
          renderTasksArea();
        }
      });
    });

    function showBlankPage(name){
      const container = document.createElement('div');
      container.style.padding = "24px";
      container.innerHTML = `<h2 style="margin-bottom:10px">${name.charAt(0).toUpperCase()+name.slice(1)}</h2><p>Tela em branco por enquanto.</p>`;
      // limpa main-area e coloca apenas o componente
      const main = document.querySelector('.main');
      main.innerHTML = '';
      main.appendChild(container);
    }

    /***********************
     * Modal handling
     ***********************/
    const modalCat = document.getElementById('modal-categoria-backdrop');
    const modalTask = document.getElementById('modal-tarefa-backdrop');

    document.getElementById('btn-criar-categoria').addEventListener('click', ()=>{ modalCat.style.display='flex'; });
    document.getElementById('cat-cancel').addEventListener('click', ()=>{ modalCat.style.display='none'; });
    document.getElementById('btn-criar-tarefa').addEventListener('click', ()=>{ modalTask.style.display='flex'; });
    document.getElementById('task-cancel').addEventListener('click', ()=>{ modalTask.style.display='none'; });

    // fechar clicando fora
    modalCat.addEventListener('click', (e)=>{ if (e.target===modalCat) modalCat.style.display='none'; });
    modalTask.addEventListener('click', (e)=>{ if (e.target===modalTask) modalTask.style.display='none'; });

    /***********************
     * State
     ***********************/
    let categorias = []; // {id,nome,descricao}
    let tarefas = []; // array de tarefas vindo do backend

    /***********************
     * Fetch helpers
     ***********************/
    async function fetchCategorias(){
      try{
        const res = await fetch(ENDPOINTS.categorias_listar);
        if (!res.ok) throw new Error('Erro ao listar categorias');
        categorias = await res.json();
        populateCategoriaSelects();
      } catch(err){
        console.error(err);
        showToast('Erro ao carregar categorias (ver console).');
      }
    }

    async function fetchTarefas(){
      try{
        const res = await fetch(ENDPOINTS.tarefas_listar);
        if (!res.ok) throw new Error('Erro ao listar tarefas');
        tarefas = await res.json();
        renderTasks(tarefas);
      } catch(err){
        console.error(err);
        showToast('Erro ao carregar tarefas (ver console).');
      }
    }

    async function salvarCategoria(payload){
      const res = await fetch(ENDPOINTS.categorias_salvar, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error('Erro ao salvar categoria');
      return await res.json();
    }

    async function salvarTarefa(payload){
      const res = await fetch(ENDPOINTS.tarefas_salvar, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error('Erro ao salvar tarefa');
      return await res.json();
    }

    async function atualizarTarefa(payload){
      const res = await fetch(ENDPOINTS.tarefas_atualizar, {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error('Erro ao atualizar tarefa');
      return await res.json();
    }

    async function deletarTarefa(id){
      // v√°rias APIs aceitam DELETE /tarefas/deletar/{id} ‚Äî se for seu caso ajuste abaixo.
      // Aqui tentamos enviar DELETE com query ?id=...
      const url = ENDPOINTS.tarefas_deletar + '?id=' + encodeURIComponent(id);
      const res = await fetch(url, { method:'DELETE' });
      if (!res.ok) throw new Error('Erro ao deletar');
      return await res.json();
    }

    /***********************
     * UI render
     ***********************/
    const tasksArea = document.getElementById('tasks-area');

    function renderTasks(list){
      tasksArea.innerHTML = '';
      if (!list || list.length === 0) {
        tasksArea.innerHTML = '<div style="grid-column:1/-1;padding:18px;background:#fff;border-radius:12px;border:1px dashed #ddd">Nenhuma tarefa encontrada.</div>';
        return;
      }

      list.forEach(t => {
        const card = document.createElement('div');
        card.className = 'card';
        // prioridade class
        let prClass = t.prioridade === 'ALTA' ? 'priority-high' : (t.prioridade === 'MEDIA' ? 'priority-med' : 'priority-low');
        // categoria nome
        const cat = categorias.find(c=>String(c.id)===String(t.categoriaId)) || null;
        card.innerHTML = `
          <div class="actions">
            <button class="icon-btn" title="Toggle Conclu√≠do" data-id="${t.id}" data-action="toggle">‚úî</button>
            <button class="icon-btn" title="Deletar" data-id="${t.id}" data-action="delete">‚úñ</button>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:flex-start">
            <div>
              <div class="title">${escapeHtml(t.titulo || 'Sem t√≠tulo')}</div>
              <div style="font-size:13px;color:#666">${cat ? escapeHtml(cat.nome) : ''}</div>
            </div>
            <div style="text-align:right">
              <div class="tag ${prClass}">${t.prioridade}</div>
            </div>
          </div>
          <div class="meta">
            <div>üìÖ ${formatDateRange(t.dataInicio, t.dataFim)}</div>
            <div style="margin-left:auto;font-weight:700;color:${t.status==='CONCLUIDO' ? '#388e3c' : (t.status==='ATRASADO' ? '#d32f2f':'#1976d2')}">${t.status}</div>
          </div>
          <div style="color:#444;font-size:14px;margin-top:6px">${escapeHtml(t.descricao || '')}</div>
        `;
        // eventos dos bot√µes
        card.querySelectorAll('button.icon-btn').forEach(b=>{
          b.addEventListener('click', async (ev)=>{
            const id = b.dataset.id;
            const action = b.dataset.action;
            if (action === 'delete') {
              if (!confirm('Deletar tarefa?')) return;
              try{
                await deletarTarefa(id);
                await fetchTarefas();
                showToast('Tarefa deletada');
              }catch(e){ console.error(e); showToast('Erro ao deletar (veja console)'); }
            } else if (action === 'toggle') {
              // trocar status para CONCLUIDO se n√£o for, sen√£o EM_ANDAMENTO
              const current = tarefas.find(x=>String(x.id)===String(id));
              if (!current) return showToast('Tarefa n√£o encontrada');
              const novo = current.status === 'CONCLUIDO' ? 'EM_ANDAMENTO' : 'CONCLUIDO';
              try{
                const payload = {...current, status: novo};
                await atualizarTarefa(payload);
                await fetchTarefas();
                showToast('Status atualizado');
              }catch(err){ console.error(err); showToast('Erro ao atualizar'); }
            }
          });
        });

        tasksArea.appendChild(card);
      });
    }

    function renderTasksArea(){
      // recarrega layout original (caso tiv√©ssemos trocado pra tela em branco)
      const main = document.querySelector('.main');
      if (!main.querySelector('.tasks-area')) {
        main.innerHTML = `
          <section style="flex:1">
            <h2 style="margin-bottom:12px">Tarefas</h2>
            <div class="tasks-area" id="tasks-area"></div>
          </section>
          <aside style="width:320px;background:#fff;border-radius:12px;padding:16px;height:360px">
            <h3 id="right-title">Painel</h3>
            <p style="color:#666">Resumo rapido. Clique nas outras abas do menu para ver telas em branco com o nome delas.</p>
          </aside>
        `;
        // rebind tasksArea var
        window.tasksArea = document.getElementById('tasks-area');
      }
      // recarregar dados
      fetchCategorias().then(()=>fetchTarefas());
    }

    /***********************
     * Form handlers
     ***********************/
    document.getElementById('form-categoria').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const nome = document.getElementById('cat-nome').value.trim();
      const descricao = document.getElementById('cat-descricao').value.trim();
      if (!nome) return alert('Nome obrigat√≥rio');
      try{
        await salvarCategoria({nome, descricao});
        modalCat.style.display='none';
        document.getElementById('form-categoria').reset();
        await fetchCategorias();
        showToast('Categoria salva');
      }catch(err){ console.error(err); alert('Erro ao salvar categoria (ver console)'); }
    });

    document.getElementById('form-tarefa').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload = {
        titulo: document.getElementById('task-titulo').value.trim(),
        descricao: document.getElementById('task-descricao').value.trim(),
        status: document.getElementById('task-status').value,
        prioridade: document.getElementById('task-prioridade').value,
        dataInicio: document.getElementById('task-data-inicio').value || null,
        dataFim: document.getElementById('task-data-fim').value || null,
        categoriaId: document.getElementById('task-categoria').value || null
      };
      try{
        await salvarTarefa(payload);
        modalTask.style.display='none';
        document.getElementById('form-tarefa').reset();
        await fetchTarefas();
        showToast('Tarefa criada');
      }catch(err){ console.error(err); alert('Erro ao salvar tarefa (ver console)'); }
    });

    /***********************
     * Filtros
     ***********************/
    document.getElementById('btn-buscar').addEventListener('click', ()=>{
      const cat = document.getElementById('filter-categoria').value;
      const data = document.getElementById('filter-data').value;
      const prioridade = document.getElementById('filter-prioridade').value;
      const status = document.getElementById('filter-status').value;

      let resultado = [...tarefas];

      if (cat) resultado = resultado.filter(t => String(t.categoriaId) === String(cat));
      if (prioridade) resultado = resultado.filter(t => t.prioridade === prioridade);
      if (status) resultado = resultado.filter(t => t.status === status);

      if (data) {
        const now = new Date();
        resultado = resultado.filter(t => {
          const start = t.dataInicio ? new Date(t.dataInicio) : null;
          const end = t.dataFim ? new Date(t.dataFim) : null;
          if (!start && !end) return false;
          if (data === 'hoje') {
            return dateInRange(now, start, end, 'day');
          } else if (data === 'semana') {
            return dateInRange(now, start, end, 'week');
          } else if (data === 'mes') {
            return dateInRange(now, start, end, 'month');
          }
          return true;
        });
      }

      renderTasks(resultado);
    });

    document.getElementById('btn-mostrar-todos').addEventListener('click', ()=>{
      renderTasks(tarefas);
      // reset filtros (opcional)
      document.getElementById('filter-categoria').value = '';
      document.getElementById('filter-data').value = '';
      document.getElementById('filter-prioridade').value = '';
      document.getElementById('filter-status').value = '';
    });

    /***********************
     * Utils
     ***********************/
    function populateCategoriaSelects(){
      const sel1 = document.getElementById('filter-categoria');
      const sel2 = document.getElementById('task-categoria');
      sel1.innerHTML = '<option value="">Todas</option>';
      sel2.innerHTML = '<option value="">-- Sem categoria --</option>';
      categorias.forEach(c=>{
        const o = document.createElement('option'); o.value = c.id; o.textContent = c.nome;
        sel1.appendChild(o);
        const o2 = o.cloneNode(true);
        sel2.appendChild(o2);
      });
    }

    function formatDateRange(a,b){
      if (!a && !b) return 'Sem data';
      if (a && b) return `${formatShortDate(a)} ‚Üí ${formatShortDate(b)}`;
      return a ? `Inicia ${formatShortDate(a)}` : `At√© ${formatShortDate(b)}`;
    }
    function formatShortDate(d){
      if (!d) return '';
      const dt = new Date(d);
      return dt.toLocaleDateString();
    }

    function dateInRange(ref,start,end,mode){
      if (!start && !end) return false;
      const s = start || end;
      const e = end || start;
      const r = new Date(ref);
      if (mode==='day') {
        return r.toDateString() === s.toDateString();
      } else if (mode==='week') {
        // semana atual (segunda-domingo) - aproxima√ß√£o
        const startOfWeek = new Date(r); startOfWeek.setDate(r.getDate() - r.getDay() + 1);
        startOfWeek.setHours(0,0,0,0);
        const endOfWeek = new Date(startOfWeek); endOfWeek.setDate(startOfWeek.getDate()+6); endOfWeek.setHours(23,59,59,999);
        return (new Date(s) <= endOfWeek && new Date(e) >= startOfWeek);
      } else if (mode==='month') {
        return (new Date(s).getMonth() === r.getMonth() && new Date(s).getFullYear() === r.getFullYear())
            || (new Date(e).getMonth() === r.getMonth() && new Date(e).getFullYear() === r.getFullYear());
      }
      return false;
    }

    function escapeHtml(str){
      if (!str) return '';
      return String(str).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" })[m]);
    }

    function showToast(msg){
      // simples
      alert(msg);
    }

    /***********************
     * Inicializa√ß√£o
     ***********************/
    // carregar lista inicial
    renderTasksArea();

    // se precisar de hot-reload no dev, voc√™ pode chamar fetchTarefas() manualmente
</script>
</body>
</html>
